{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ url_for('frontend.static', filename='css/system.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('frontend.static', filename='css/annotations.css') }}">
{% endblock %}

{% block title %}{{ metadata.name }} Measurements{% endblock %}

{% block content %}
    <div class="container" style="width: 100%; margin-top: 2%; margin-left: 2%">
        <div class="row">
            {% if metadata.user == session['uid'] %}
                <div class="col-md-2">
                    <ul class="nav nav-stacked">
                        <li id="overview-li">
                            <a href="{{ url_for("frontend.sys_overview", system_uid=metadata.UID) }}"
                               title="Overview">Overview</a>
                        </li>
                        <li id="measurement-li" class="active">
                            <a href="{{ url_for("frontend.sys_measurements", system_uid=metadata.UID) }}"
                               title="Measurement">Measurements</a>
                        </li>
                        <li id="annotate-li">
                            <a href="{{ url_for("frontend.sys_annotations", system_uid=metadata.UID) }}"
                               title="Annotations">Annotations <span class="sr-only">(current)</span></a>
                        </li>
{#                        <li id="social-li"><a#}
{#                                href="{{ url_for("social.view_system", system_uid=metadata.UID) }}" title="Social">#}
{#                            Social</a>#}
{#                        </li>#}
                        <li id="analytics-li">
                            <a href="{{ url_for('dav.system_analyze', system_uid=metadata.UID) }}" title="Analytics">Analytics</a>
                        </li>
                    </ul>
                </div>
                <div class="col-sm-7">
                    <h2>Input Measurements</h2>
                    <hr>
                    <div ng-controller="MeasurementController">
                        <div class="form-group">
                            <label for="measure-id">Measurement Type:</label>
                            <select class="form-control id" ng-model="measure.measurement_id" id="measure-id" ng-click="clearMessage()" required>
                                {# TODO Hard-coded values here. NO BUENO!#}
                                <option value="1">Alkalinity</option>
                                <option value="2">Ammonium</option>
                                <option value="3">Chlorine</option>
                                <option value="4">Hardness</option>
                                <option value="5">Light</option>
                                <option value="6">Nitrate</option>
                                <option value="7">Nitrite</option>
                                <option value="8">Dis. Oxygen</option>
                                <option value="9">pH</option>
                                <option value="10">Temperature</option>
                                <option value="12">Leaf Count</option>
                                <option value="13">Height</option>
                            </select>
                            <hr>
                        </div>
                        <form ng-show="measure.measurement_id" ng-switch on="measure.measurement_id" name="boardForm">
                            <span class="hidden" id="UID">{{ metadata.UID }}</span>
                            <div class="form-group">
                                <label for="measure-datetime">Date & Time</label>
                                <p>Enter in the date and time of when you collected the measurement.</p>
                                <input class="form-control dt" type="datetime-local"
                                       id="measure-datetime" name="measureDateTime" date-time ng-model="inputdate" required />
                            </div>
                            <div class="form-group">
                                <label for="measure-value">Value</label>
                                <p>Enter in the value of the measurement.</p>
                                <div class="input-group">
                                    <div ng-switch on="measure.measurement_id">
                                        <input ng-switch-when="12" id="measure-value" class="form-control val" name="measure-value" type="number"
                                               pattern="[0-9]+(.[0-9]+)?" style="text-align: right;" placeholder="0"
                                               step="1" min="0" max="100000"
                                               aria-describedby="addon" ng-model="measure.value" required>
                                        <input  ng-switch-default id="measure-value" class="form-control val" name="measure-value" type="number"
                                                pattern="[0-9]+(.[0-9]+)?" style="text-align: right;" placeholder="0.00"
                                                step="0.01" min="0" max="1000"
                                                aria-describedby="addon" ng-model="measure.value" required>
                                    </div>
                                    <span ng-switch-when="5" id="addon" class="input-group-addon">lux</span>
                                    <span ng-switch-when="9" id="addon" class="input-group-addon">&nbsp;</span>
                                    <span ng-switch-when="10" id="addon" class="input-group-addon">&deg;C</span>
                                    <span ng-switch-when="12" id="addon" class="input-group-addon">leaves</span>
                                    <span ng-switch-when="13" id="addon" class="input-group-addon">cm</span>
                                    <span ng-switch-default id="addon" class="input-group-addon">mg/L</span>
                                </div>
                            </div>

                            <div ng-show="message" class="alert alert-warning alert-dismissable" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                Measurement has been added!
                            </div>
                            <div ng-show="error1" class="alert alert-danger alert-dismissable" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                Looks like you've already entered a measurement for this date and time! Try again with a different date and/or time.
                            </div>
                            <div ng-show="error2" class="alert alert-danger alert-dismissable" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                No measurement date was input. Please try again.
                            </div>
                            <!-- button panel -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-green" ng-click="addMeasurement(measure)">
                                    Submit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-sm-3 hidden-xs hidden-sm">
                    <h4>Latest Measurements</h4>
                    <hr>
{#                    <p>If you have added a measurement and it is not reflected below, try refreshing your page.</p>#}
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Last Updated</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for reading in readings %}
                            <tr>
                                <td>{{ reading.name }}</td>
                                {% if reading.value %}
                                    <td>{{ reading.value }}</td>
                                {% else %}
                                    <td>-</td>
                                {% endif %}
                                {% if reading.updated_at %}
                                    <td>{{ reading.updated_at|datetime }}</td>
                                {% else %}
                                    <td>-</td>
                                {% endif %}
                                <td>
                                    {% if reading.value %}
                                        <a href="/system/{{ metadata.UID  }}/measurements/{{ reading.name }}/data" class="pull-right">
                                            <span title="View history" class="glyphicon glyphicon-list-alt"></span>
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reading.value %}
                                        <a href="/system/{{ metadata.UID  }}/measurements/{{ reading.name }}/edit/{{ reading.created_at }}" class="pull-right">
                                            <span title="Edit this measurement" class="glyphicon glyphicon-pencil"></span>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <h3>Oops! Looks like this isn't your system.</h3>
                <p>Please hit the 'Back' key or go to 'Home'</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script src="{{ url_for('frontend.static', filename='js/jquery.numeric.min.js') }}"></script>
    <script src="{{ url_for('frontend.static', filename='js/sys_measurements.js') }}"></script>
    <script>
        $("select.id").change(function() {
            if ($(this).val() == "1") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 300.00);
            } else if ($(this).val() == "2") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 6.00);
            } else if ($(this).val() == "3") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 1000000.00);
            } else if ($(this).val() == "4") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 300.00);
            } else if ($(this).val() == "5") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 1000000.00);
            } else if ($(this).val() == "6") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 200.00);
            } else if ($(this).val() == "7") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 10.00);
            } else if ($(this).val() == "8") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 1000000.00);
            } else if ($(this).val() == "9") {
                $("input.val").attr('min', 5.00);
                $("input.val").attr('max', 9.00);
            } else if ($(this).val() == "10") {
                $("input.val").attr('min', 18.00);
                $("input.val").attr('max', 33.00);
            } else if ($(this).val() == "12") {
                $("input.val").attr('min', 0);
                $("input.val").attr('max', 1000000);
            }
            else if ($(this).val() == "13") {
                $("input.val").attr('min', 0.00);
                $("input.val").attr('max', 1000000.00);
            }
        });

        {#var isDragging = false;
        function updateNH4Values(posx) {
            aqx.updateStripValues(posx, 'nh4', 0.0, 6.0, aqx.nh4GradientColor);
        }
        aqx.connectStrip('nh4', updateNH4Values);
        function updateNO3Values(posx) {
            aqx.updateStripValues(posx, 'no3', 0.0, 200.0, aqx.no3GradientColor);
        }
        aqx.connectStrip('no3', updateNO3Values);
        function updateNO2Values(posx) {
            aqx.updateStripValues(posx, 'no2', 0.0, 10.0, aqx.no2GradientColor);
        }
        aqx.connectStrip('no2', updateNO2Values);
        // PH
        function updatePHValues(posx) {
            aqx.updateStripValues(posx, 'ph', 6.2, 8.4, aqx.phGradientColor);
        }
        aqx.connectStrip('ph', updatePHValues);
        // Chlorine
        function updateChlorineValues(posx) {
            aqx.updateStripValues(posx, 'cl', 0.0, 6.0, aqx.clGradientColor);
        }
        aqx.connectStrip('cl', updateChlorineValues);
        // Hardness
        function updateHardnessValues(posx) {
            aqx.updateStripValues(posx, 'hard', 0.0, 300.0, aqx.hardGradientColor);
        }
        aqx.connectStrip('hard', updateHardnessValues);
        // Alkalinity
        function updateAlkalinityValues(posx) {
            aqx.updateStripValues(posx, 'alk', 0.0, 300.0, aqx.alkGradientColor);
        }
        aqx.connectStrip('alk', updateAlkalinityValues);#}
    </script>
{% endblock scripts %}
